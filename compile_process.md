---
author: lunar
date: Tue 01 Sep 2020 12:56:38 PM CST
---

## C/C++ 编译过程详解

对于其它语言, 我们可能不需要过多在意底层编译运行的细节. 但是对于C/C++语言, 知晓源代码到机器码的过程对于程序编写非常重要.

### 预处理

首先对于源代码进行预处理, 主要包括宏的替换, 条件编译的处理以及头文件包含指令. 头文件包含即将头文件内的代码添加本文件代码中.

此外还有一些特殊字符的处理, 如`__LINE__`, `__FILE__`等等

这一步生成.i文件

### 编译

编译程序即通过词法分析和语法分析来解析源代码, 确认没有语法问题后翻译成汇编代码.

优化处理也是编译器需要完成的一些工作, 比如将乘2操作转换为<<1操作. 一般编译时都可以选择让编译器进行几级优化.

这一步生成.s文件

### 汇编

汇编即将汇编代码转换为机器码.

目标文件由段组成. 通常一个目标文件至少含有两个段:
1. 代码段: 主要包含程序指令, 可读和可执行, 但不可写.
2. 数据段: 存放程序要用的全局变量或静态变量的数据, 可读可写.

这一步生成.o文件

### 链接

编译过多个文件或者写过多个文件的makefile的同学应该明白, 通过编译并不是最难的, 最难的是通过链接. 在链接过程通常会出现各种各样的问题.

链接的主要工作是将相关的目标文件彼此连接起来, 使得称为一个可以被操作系统装入执行的整体.

链接处理可以分为两种:
1. 静态链接
在这种链接方式下, 函数的代码从其所在的静态链接库中被拷贝到最终的可执行程序中.
2. 动态链接
函数的代码还是放在静态链接库或者共享对象的某个目标文件中, 链接程序所做的只是在最终的可执行程序中记录下共享对象的名字以及其它少量的登录信息. 
可执行程序运行时, 可以根据这些登录信息找到动态链接库的代码.

显然动态链接能够减少内存的消耗, 但是会带来一些性能的损耗.

这一步生成可执行文件.

具体的编译过程是怎样执行的还需要学习完 \<编译原理\> 才能知道.
